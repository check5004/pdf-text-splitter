<!DOCTYPE html>
<html>

<head>
    <title>PDF Text Splitter</title>
    <script src="https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.worker.js"></script>
    <script src="https://unpkg.com/pdf-lib"></script>
    <style>
        #pdf-canvas {
            border: 1px solid black;
            position: relative;
        }

        .file-input-container {
            display: flex;
            align-items: center;
        }

        .selection-box {
            border: 2px dashed red;
            position: absolute;
            pointer-events: none;
        }

        .continuation-box {
            border: 2px dashed blue;
            position: absolute;
            pointer-events: none;
        }

        .preview-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid black;
            padding: 10px;
            background-color: white;
            z-index: 1000;
            overflow: auto;
            max-height: 80%;
            max-width: 80%;
        }

        .preview-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .preview-canvas-container {
            margin-bottom: 20px;
        }

        .close-button {
            position: sticky;
            top: 10px;
            right: 10px;
            z-index: 1001;
            margin-left: auto;
            float: right;
            display: block;
        }
    </style>
</head>

<body>
    <h1>PDF Text Splitter</h1>
    <div class="file-input-container">
        <input type="file" id="file-input">
        <span id="file-input-pagecount"></span>
    </div>
    <br>
    <canvas id="pdf-canvas"></canvas>
    <br>
    <button id="split-button">Split PDF</button>
    <div id="output"></div>
    <button id="download-all-button" style="display: none;">Download All PDFs</button>

    <div id="preview-overlay" class="preview-overlay"></div>
    <div id="preview-dialog" class="preview-dialog">
        <button class="close-button" onclick="closePreview()">Close</button>
        <div id="preview-canvas-container"></div>
    </div>

    <div style="height: 100px;"></div>

    <script>
        // PDFドキュメントとキャンバスの初期設定
        let pdfDoc = null;
        let pdfBytes = null;
        let canvas = document.getElementById('pdf-canvas');
        let ctx = canvas.getContext('2d');
        let selectionBox = document.createElement('div');
        selectionBox.classList.add('selection-box');
        document.body.appendChild(selectionBox);
        let continuationBox = document.createElement('div');
        continuationBox.classList.add('continuation-box');
        document.body.appendChild(continuationBox);
        let isSelecting = false;
        let isSelectingContinuation = false;
        let startX, startY, endX, endY;
        let startCX, startCY, endCX, endCY;

        // ファイル入力の変更イベントリスナー
        document.getElementById('file-input').addEventListener('change', function (event) {
            let file = event.target.files[0];
            if (file.type !== 'application/pdf') {
                alert('Please select a PDF file.');
                return;
            }
            let reader = new FileReader();

            // ファイル読み込み完了時の処理
            reader.onload = function () {
                pdfBytes = new Uint8Array(this.result);
                pdfjsLib.getDocument(pdfBytes).promise.then(function (pdf) {
                    pdfDoc = pdf;
                    renderPage(1);
                    displayFileInfo(pdf.numPages);
                });
            };

            reader.readAsArrayBuffer(file);
        });

        // PDFページをレンダリングする関数
        function renderPage(pageNumber) {
            pdfDoc.getPage(pageNumber).then(function (page) {
                let viewport = page.getViewport({ scale: 1 });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                let renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                page.render(renderContext);
            });
        }

        // ファイル情報を表示する関数
        function displayFileInfo(numPages) {
            const output = document.getElementById('file-input-pagecount');
            output.textContent = `(Pages: ${numPages})`;
        }

        // キャンバス上でのマウスダウンイベントリスナー
        canvas.addEventListener('mousedown', function (event) {
            if (event.shiftKey) {
                isSelectingContinuation = true;
                startCX = event.offsetX;
                startCY = event.offsetY;
                continuationBox.style.left = `${startCX + canvas.offsetLeft}px`;
                continuationBox.style.top = `${startCY + canvas.offsetTop}px`;
                continuationBox.style.width = '0px';
                continuationBox.style.height = '0px';
                continuationBox.style.display = 'block';
            } else {
                isSelecting = true;
                startX = event.offsetX;
                startY = event.offsetY;
                selectionBox.style.left = `${startX + canvas.offsetLeft}px`;
                selectionBox.style.top = `${startY + canvas.offsetTop}px`;
                selectionBox.style.width = '0px';
                selectionBox.style.height = '0px';
                selectionBox.style.display = 'block';
            }
        });

        // キャンバス上でのマウスムーブイベントリスナー
        canvas.addEventListener('mousemove', function (event) {
            if (isSelecting) {
                endX = event.offsetX;
                endY = event.offsetY;
                selectionBox.style.width = `${Math.abs(endX - startX)}px`;
                selectionBox.style.height = `${Math.abs(endY - startY)}px`;
                selectionBox.style.left = `${Math.min(startX, endX) + canvas.offsetLeft}px`;
                selectionBox.style.top = `${Math.min(startY, endY) + canvas.offsetTop}px`;
            } else if (isSelectingContinuation) {
                endCX = event.offsetX;
                endCY = event.offsetY;
                continuationBox.style.width = `${Math.abs(endCX - startCX)}px`;
                continuationBox.style.height = `${Math.abs(endCY - startCY)}px`;
                continuationBox.style.left = `${Math.min(startCX, endCX) + canvas.offsetLeft}px`;
                continuationBox.style.top = `${Math.min(startCY, endCY) + canvas.offsetTop}px`;
            }
        });

        // キャンバス上でのマウスアップイベントリスナー
        canvas.addEventListener('mouseup', function (event) {
            isSelecting = false;
            isSelectingContinuation = false;
        });

        // PDF分割ボタンのクリックイベントリスナー
        document.getElementById('split-button').addEventListener('click', function () {
            if (!pdfDoc) {
                alert('Please select a PDF file.');
                return;
            }

            let selection = {
                x: parseFloat(selectionBox.style.left) - canvas.offsetLeft,
                y: parseFloat(selectionBox.style.top) - canvas.offsetTop,
                width: parseFloat(selectionBox.style.width),
                height: parseFloat(selectionBox.style.height)
            };

            let continuationSelection = {
                x: parseFloat(continuationBox.style.left) - canvas.offsetLeft,
                y: parseFloat(continuationBox.style.top) - canvas.offsetTop,
                width: parseFloat(continuationBox.style.width),
                height: parseFloat(continuationBox.style.height)
            };

            extractTextAndSplit(selection, continuationSelection);
        });

        // 選択範囲のテキストを抽出し、PDFを分割する関数
        async function extractTextAndSplit(selection, continuationSelection) {
            let textPromises = [];
            let pages = [];

            for (let i = 1; i <= pdfDoc.numPages; i++) {
                textPromises.push(pdfDoc.getPage(i).then(function (page) {
                    return page.getTextContent().then(function (textContent) {
                        let viewport = page.getViewport({ scale: 1 });
                        let pageText = textContent.items.map(function (item) {
                            let tx = item.transform;
                            let x = tx[4];
                            let y = viewport.height - tx[5];
                            return {
                                str: item.str,
                                x: x,
                                y: y
                            };
                        }).filter(function (item) {
                            return item.x >= selection.x &&
                                item.x <= selection.x + selection.width &&
                                item.y >= selection.y &&
                                item.y <= selection.y + selection.height;
                        }).map(item => item.str).join(' ');

                        let continuationText = textContent.items.map(function (item) {
                            let tx = item.transform;
                            let x = tx[4];
                            let y = viewport.height - tx[5];
                            return {
                                str: item.str,
                                x: x,
                                y: y
                            };
                        }).filter(function (item) {
                            return item.x >= continuationSelection.x &&
                                item.x <= continuationSelection.x + continuationSelection.width &&
                                item.y >= continuationSelection.y &&
                                item.y <= continuationSelection.y + continuationSelection.height;
                        }).map(item => item.str).join(' ');

                        pages.push({
                            pageNumber: i,
                            redText: pageText,
                            blueText: continuationText
                        });
                    });
                }));
            }

            await Promise.all(textPromises);

            // ページオブジェクトをページ番号でソート
            pages.sort((a, b) => a.pageNumber - b.pageNumber);

            // ページオブジェクトからファイル単位のページ番号を抽出
            let files = [];
            let currentFile = [];
            let lastRedText = '';
            let lastBlueText = '';

            pages.forEach(page => {
                if (page.redText !== lastRedText || page.blueText !== lastBlueText) {
                    if (currentFile.length > 0) {
                        files.push(currentFile);
                    }
                    currentFile = [page.pageNumber];
                    lastRedText = page.redText;
                    lastBlueText = page.blueText;
                } else {
                    currentFile.push(page.pageNumber);
                }
            });

            if (currentFile.length > 0) {
                files.push(currentFile);
            }

            // 続きページを前のファイルに結合
            let mergedFiles = [];
            let lastFile = [];
            let ignoreContinuation = false;

            files.forEach(file => {
                if (lastFile.length > 0 && !ignoreContinuation &&
                    pages[file[0] - 1].redText !== pages[lastFile[lastFile.length - 1] - 1].redText &&
                    pages[file[0] - 1].blueText !== pages[lastFile[lastFile.length - 1] - 1].blueText) {
                    lastFile.push(...file);
                    ignoreContinuation = true; // 続きページを無視するフラグを立てる
                } else {
                    if (lastFile.length > 0) {
                        mergedFiles.push(lastFile);
                    }
                    lastFile = file;
                    ignoreContinuation = false; // 新しいファイルの開始時にフラグをリセット
                }
            });

            if (lastFile.length > 0) {
                mergedFiles.push(lastFile);
            }

            createPDFs(mergedFiles, pages, pdfBytes);
        }

        // 分割されたPDFを作成する関数
        async function createPDFs(files, pages, pdfBytes) {
            const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
            const output = document.getElementById('output');
            output.innerHTML = '<ul>';

            const newOutput = output.cloneNode(true);
            output.parentNode.replaceChild(newOutput, output);

            newOutput.addEventListener('click', function (event) {
                if (event.target.tagName === 'BUTTON' && event.target.textContent === 'Preview') {
                    const previewUrl = event.target.getAttribute('data-url');
                    previewPDF(previewUrl);
                }
            });

            for (let i = 0; i < files.length; i++) {
                const newPdfDoc = await PDFLib.PDFDocument.create();
                const pagesToInclude = await newPdfDoc.copyPages(pdfDoc, files[i].map(p => p - 1));
                pagesToInclude.forEach(page => {
                    newPdfDoc.addPage(page);
                });

                const newPdfBytes = await newPdfDoc.save();
                const blob = new Blob([newPdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const listItem = document.createElement('li');

                const link = document.createElement('a');
                link.href = url;
                link.download = `split_part_${i + 1}.pdf`;
                link.textContent = `Download split_part_${i + 1}.pdf`;

                const snippetSpan = document.createElement('span');
                snippetSpan.textContent = ` (Snippet: ${pages[files[i][0] - 1].redText})`;

                const previewButton = document.createElement('button');
                previewButton.textContent = 'Preview';
                previewButton.setAttribute('data-url', url);

                const pageCountSpan = document.createElement('span');
                pageCountSpan.textContent = ` (Pages: ${files[i].length})`;

                listItem.appendChild(link);
                listItem.appendChild(snippetSpan);
                listItem.appendChild(previewButton);
                listItem.appendChild(pageCountSpan);
                newOutput.appendChild(listItem);
            }

            newOutput.innerHTML += '</ul>';

            // Split後にダウンロードボタンを表示
            if (files.length > 0) {
                document.getElementById('download-all-button').style.display = 'block';
            }
        }

        // PDFをプレビューする関数
        function previewPDF(url) {
            const previewCanvasContainer = document.getElementById('preview-canvas-container');
            previewCanvasContainer.innerHTML = ''; // Clear previous content
            const previewDialog = document.getElementById('preview-dialog');
            const previewOverlay = document.getElementById('preview-overlay');
            previewOverlay.style.display = 'block';
            previewDialog.style.display = 'block';

            pdfjsLib.getDocument(url).promise.then(function (pdf) {
                let renderPage = function (pageNum) {
                    pdf.getPage(pageNum).then(function (page) {
                        let viewport = page.getViewport({ scale: 1 });
                        let previewCanvas = document.createElement('canvas');
                        previewCanvas.height = viewport.height;
                        previewCanvas.width = viewport.width;

                        let previewCtx = previewCanvas.getContext('2d');

                        let renderContext = {
                            canvasContext: previewCtx,
                            viewport: viewport
                        };
                        page.render(renderContext).promise.then(function () {
                            previewCanvasContainer.appendChild(previewCanvas);

                            // Add a separator line between pages
                            if (pageNum < pdf.numPages) {
                                let separator = document.createElement('div');
                                separator.style.borderTop = '1px solid gray';
                                separator.style.margin = '10px 0';
                                previewCanvasContainer.appendChild(separator);
                            }

                            // Render the next page
                            if (pageNum < pdf.numPages) {
                                renderPage(pageNum + 1);
                            }
                        });
                    });
                };

                // Start rendering from the first page
                renderPage(1);
            });
        }

        // プレビューを閉じる関数
        function closePreview() {
            const previewDialog = document.getElementById('preview-dialog');
            const previewOverlay = document.getElementById('preview-overlay');
            previewDialog.style.display = 'none';
            previewOverlay.style.display = 'none';
        }

        // 全てのPDFをダウンロードするボタンのクリックイベントリスナー
        document.getElementById('download-all-button').addEventListener('click', function () {
            const links = document.querySelectorAll('#output a');
            links.forEach(link => {
                const url = link.href;
                const filename = link.download;
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
        });
    </script>
</body>

</html>